# üóÑÔ∏è Guia Completo: Configura√ß√£o do Supabase

![Stellar Stake House Logo](./frontend/src/assets/logo.svg)

## ‚úÖ **STATUS: SUPABASE CONFIGURADO E FUNCIONAL**

**URL**: https://psqcaaydgginbomikotq.supabase.co  
**Status**: ‚úÖ Conectado e funcionando  
**Schema**: ‚úÖ Aplicado com todas as tabelas  
**Service Role Key**: ‚úÖ Configurada corretamente

## üìã √çndice
1. [Cria√ß√£o da Conta e Projeto](#cria√ß√£o-da-conta-e-projeto)
2. [Configura√ß√£o do Banco de Dados](#configura√ß√£o-do-banco-de-dados)
3. [Configura√ß√£o de Autentica√ß√£o](#configura√ß√£o-de-autentica√ß√£o)
4. [Configura√ß√£o de Seguran√ßa (RLS)](#configura√ß√£o-de-seguran√ßa-rls)
5. [Obten√ß√£o das Credenciais](#obten√ß√£o-das-credenciais)
6. [Configura√ß√£o no Projeto](#configura√ß√£o-no-projeto)
7. [Testes e Verifica√ß√£o](#testes-e-verifica√ß√£o)
8. [Troubleshooting](#troubleshooting)

---

## üöÄ Cria√ß√£o da Conta e Projeto

### Passo 1: Criar Conta no Supabase

1. **Acesse o Supabase**
   - V√° para: https://supabase.com
   - Clique em "Start your project"

2. **Criar Conta**
   - Clique em "Sign Up"
   - Use GitHub, Google ou email
   - Confirme seu email se necess√°rio

3. **Criar Novo Projeto**
   - Clique em "New Project"
   - Escolha uma organiza√ß√£o (ou crie uma)
   - Preencha os dados:
     ```
     Project Name: stellar-stake-house
     Database Password: [SENHA FORTE - ANOTE!] 
     Region: [Escolha mais pr√≥xima - ex: South America (S√£o Paulo)]
     Pricing Plan: Free (para come√ßar)
     ```
   - Clique em "Create new project"

4. **Aguardar Cria√ß√£o**
   - O projeto leva 1-2 minutos para ser criado
   - Voc√™ ver√° uma tela de loading
   - Quando pronto, ser√° redirecionado para o dashboard

---

## üóÉÔ∏è Configura√ß√£o do Banco de Dados

### Passo 2: Executar Schema SQL

1. **Acessar SQL Editor**
   - No dashboard do Supabase
   - Clique em "SQL Editor" no menu lateral
   - Clique em "New Query"

2. **Executar Script de Cria√ß√£o**
   - Copie todo o conte√∫do do arquivo `database/schema.sql`
   - Cole no editor SQL
   - Clique em "Run" (ou Ctrl+Enter)

3. **Verificar Cria√ß√£o das Tabelas**
   - V√° para "Table Editor" no menu lateral
   - Voc√™ deve ver as tabelas:
     
     **Staking Original:**
     ```
     ‚úÖ users
     ‚úÖ sessions
     ‚úÖ staking_delegations
     ‚úÖ snapshots
     ‚úÖ rewards
     ‚úÖ history
     ```
     
     **Sistema de Pools (Novo):**
     ```
     ‚úÖ pools
     ‚úÖ pool_delegations
     ‚úÖ pool_rewards
     ```

### Passo 3: Verificar Estrutura das Tabelas

#### Tabela `users`
```sql
-- Verificar estrutura
SELECT column_name, data_type, is_nullable 
FROM information_schema.columns 
WHERE table_name = 'users';
```

**Colunas esperadas:**
- `id` (uuid, primary key)
- `stellar_public_key` (text, unique)
- `email` (text, nullable)
- `username` (text, nullable)
- `created_at` (timestamp)
- `updated_at` (timestamp)
- `last_login` (timestamp)
- `is_active` (boolean)

#### Tabela `staking_positions`
```sql
-- Verificar estrutura
SELECT column_name, data_type, is_nullable 
FROM information_schema.columns 
WHERE table_name = 'staking_positions';
```

**Colunas esperadas:**
- `id` (uuid, primary key)
- `user_id` (uuid, foreign key)
- `amount` (numeric)
- `start_date` (timestamp)
- `end_date` (timestamp, nullable)
- `status` (text)
- `created_at` (timestamp)

---

## üîê Configura√ß√£o de Autentica√ß√£o

### Passo 4: Configurar Providers de Autentica√ß√£o

1. **Acessar Configura√ß√µes de Auth**
   - V√° para "Authentication" > "Settings"
   - Na se√ß√£o "Auth Providers"

2. **Configurar Email/Password**
   - Habilite "Enable email confirmations": `false` (para desenvolvimento)
   - Habilite "Enable email change confirmations": `false`
   - Site URL: `http://localhost:5173` (desenvolvimento)
   - Redirect URLs: `http://localhost:5173/**`

3. **Configurar URLs de Redirecionamento**
   ```
   Site URL: http://localhost:5173
   
   Additional Redirect URLs:
   http://localhost:5173
   http://localhost:5173/auth/callback
   http://localhost:3000 (se usando Docker)
   http://localhost:3000/auth/callback
   ```

### Passo 5: Configurar Pol√≠ticas de Senha

1. **Ir para Auth > Settings**
2. **Password Policy:**
   ```
   Minimum password length: 8
   Require uppercase: false (para facilitar desenvolvimento)
   Require lowercase: false
   Require numbers: false
   Require special characters: false
   ```

---

## üõ°Ô∏è Configura√ß√£o de Seguran√ßa (RLS)

### Passo 6: Habilitar Row Level Security

1. **Acessar SQL Editor**
2. **Executar comandos RLS:**

```sql
-- Habilitar RLS em todas as tabelas
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE staking_positions ENABLE ROW LEVEL SECURITY;
ALTER TABLE rewards ENABLE ROW LEVEL SECURITY;
ALTER TABLE snapshots ENABLE ROW LEVEL SECURITY;
ALTER TABLE transactions ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_settings ENABLE ROW LEVEL SECURITY;
```

### Passo 7: Criar Pol√≠ticas de Acesso

```sql
-- Pol√≠tica para tabela users
CREATE POLICY "Users can view own profile" ON users
    FOR SELECT USING (auth.uid() = id);

CREATE POLICY "Users can update own profile" ON users
    FOR UPDATE USING (auth.uid() = id);

-- Pol√≠tica para staking_positions
CREATE POLICY "Users can view own staking positions" ON staking_positions
    FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own staking positions" ON staking_positions
    FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own staking positions" ON staking_positions
    FOR UPDATE USING (auth.uid() = user_id);

-- Pol√≠tica para rewards
CREATE POLICY "Users can view own rewards" ON rewards
    FOR SELECT USING (auth.uid() = user_id);

-- Pol√≠tica para transactions
CREATE POLICY "Users can view own transactions" ON transactions
    FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own transactions" ON transactions
    FOR INSERT WITH CHECK (auth.uid() = user_id);

-- Pol√≠tica para user_settings
CREATE POLICY "Users can manage own settings" ON user_settings
    FOR ALL USING (auth.uid() = user_id);

-- Pol√≠tica para snapshots (somente leitura para todos)
CREATE POLICY "Anyone can view snapshots" ON snapshots
    FOR SELECT TO authenticated USING (true);
```

### Passo 8: Verificar Pol√≠ticas

```sql
-- Verificar se pol√≠ticas foram criadas
SELECT schemaname, tablename, policyname, permissive, roles, cmd, qual
FROM pg_policies
WHERE schemaname = 'public';
```

---

## üîë Obten√ß√£o das Credenciais

### Passo 9: Coletar Informa√ß√µes da API

1. **Acessar Settings > API**
2. **Copiar as seguintes informa√ß√µes:**

```bash
# Project URL
Project URL: https://[SEU-PROJECT-ID].supabase.co

# API Keys
Anon/Public Key: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Service Role Key: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# Database URL (para conex√µes diretas)
Database URL: postgresql://postgres:[PASSWORD]@db.[PROJECT-ID].supabase.co:5432/postgres
```

3. **‚ö†Ô∏è IMPORTANTE: Seguran√ßa das Chaves**
   - **Anon Key**: Pode ser exposta no frontend
   - **Service Role Key**: NUNCA exponha no frontend, apenas no backend
   - **Database URL**: Apenas para conex√µes diretas do backend

---

## ‚öôÔ∏è Configura√ß√£o no Projeto

### Passo 10: Configurar Vari√°veis de Ambiente

#### Backend (.env-dev, .env-homolog, .env-prod)
```env
# Supabase Configuration
SUPABASE_URL=https://[SEU-PROJECT-ID].supabase.co
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
DATABASE_URL=postgresql://postgres:[PASSWORD]@db.[PROJECT-ID].supabase.co:5432/postgres

# JWT Configuration (use o mesmo JWT Secret do Supabase)
JWT_SECRET=[COPIE-DO-SUPABASE-SETTINGS-API]
```

#### Frontend (.env)
```env
# Frontend s√≥ precisa da URL e Anon Key
VITE_SUPABASE_URL=https://[SEU-PROJECT-ID].supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
VITE_API_URL=http://localhost:3001
```

### Passo 11: Verificar JWT Secret

1. **No Supabase Dashboard**
   - V√° para Settings > API
   - Procure por "JWT Settings"
   - Copie o "JWT Secret"

2. **Configurar no Backend**
   ```env
   JWT_SECRET=[COLE-O-JWT-SECRET-DO-SUPABASE]
   ```

---

## üß™ Testes e Verifica√ß√£o

### Passo 12: Testar Conex√£o

#### Teste 1: Conex√£o B√°sica
```bash
# No terminal, dentro da pasta backend
node -e "
const { createClient } = require('@supabase/supabase-js');
const supabase = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_ANON_KEY
);
supabase.from('users').select('count').then(console.log);
"
```

#### Teste 2: Verificar Tabelas
```sql
-- No SQL Editor do Supabase
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_type = 'BASE TABLE';
```

#### Teste 3: Inserir Dados de Teste
```sql
-- Inserir usu√°rio de teste
INSERT INTO users (stellar_public_key, username, email) 
VALUES ('GTEST123...', 'usuario_teste', 'teste@example.com');

-- Verificar inser√ß√£o
SELECT * FROM users WHERE username = 'usuario_teste';
```

### Passo 13: Testar Autentica√ß√£o

```javascript
// Teste no console do browser (F12)
const { createClient } = supabase;
const supabaseClient = createClient(
  'https://[SEU-PROJECT-ID].supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
);

// Testar consulta
supabaseClient.from('users').select('*').then(console.log);
```

### Passo 14: Verificar RLS

```sql
-- Testar se RLS est√° funcionando
-- Este comando deve falhar se RLS estiver ativo
SELECT * FROM users;

-- Verificar status do RLS
SELECT schemaname, tablename, rowsecurity 
FROM pg_tables 
WHERE schemaname = 'public';
```

---

## üö® Troubleshooting

### Problema 1: Erro de Conex√£o

**Sintomas:**
```
Error: Invalid API key
Error: Project not found
```

**Solu√ß√µes:**
1. Verificar se URL est√° correta
2. Verificar se API key est√° correta
3. Verificar se projeto est√° ativo
4. Aguardar alguns minutos (projeto pode estar inicializando)

### Problema 2: Tabelas N√£o Encontradas

**Sintomas:**
```
Error: relation "users" does not exist
```

**Solu√ß√µes:**
1. Executar novamente o script `database/schema.sql`
2. Verificar se est√° no schema correto (`public`)
3. Verificar permiss√µes do usu√°rio

### Problema 3: RLS Bloqueando Acesso

**Sintomas:**
```
Error: new row violates row-level security policy
```

**Solu√ß√µes:**
1. Verificar se usu√°rio est√° autenticado
2. Verificar pol√≠ticas RLS
3. Temporariamente desabilitar RLS para teste:
   ```sql
   ALTER TABLE users DISABLE ROW LEVEL SECURITY;
   ```

### Problema 4: JWT Secret Incorreto

**Sintomas:**
```
Error: JWT verification failed
Error: Invalid token
```

**Solu√ß√µes:**
1. Copiar JWT Secret correto do Supabase
2. Verificar se n√£o h√° espa√ßos extras
3. Reiniciar servidor backend ap√≥s mudan√ßa

### Problema 5: CORS Error

**Sintomas:**
```
CORS policy: No 'Access-Control-Allow-Origin' header
```

**Solu√ß√µes:**
1. Verificar URLs de redirecionamento no Supabase
2. Adicionar URL do frontend nas configura√ß√µes
3. Verificar se est√° usando HTTPS em produ√ß√£o

---

## üìä Monitoramento e Logs

### Visualizar Logs do Supabase

1. **Acessar Logs**
   - No dashboard: "Logs" > "API"
   - Filtrar por tipo de erro
   - Verificar requests recentes

2. **M√©tricas de Uso**
   - "Settings" > "Usage"
   - Verificar limites do plano gratuito
   - Monitorar requests por minuto

### Backup e Restore

```bash
# Backup do banco
pg_dump "postgresql://postgres:[PASSWORD]@db.[PROJECT-ID].supabase.co:5432/postgres" > backup.sql

# Restore (cuidado!)
psql "postgresql://postgres:[PASSWORD]@db.[PROJECT-ID].supabase.co:5432/postgres" < backup.sql
```

---

## ‚úÖ Checklist Final

Antes de considerar a configura√ß√£o completa:

- [ ] Projeto Supabase criado e ativo
- [ ] Todas as tabelas criadas (users, staking_positions, rewards, etc.)
- [ ] RLS habilitado em todas as tabelas
- [ ] Pol√≠ticas de seguran√ßa criadas
- [ ] Credenciais copiadas corretamente
- [ ] Vari√°veis de ambiente configuradas
- [ ] Teste de conex√£o funcionando
- [ ] Teste de inser√ß√£o funcionando
- [ ] URLs de redirecionamento configuradas
- [ ] JWT Secret configurado
- [ ] Logs sem erros cr√≠ticos

---

## üéØ Pr√≥ximos Passos

Com o Supabase configurado:

1. **Testar Aplica√ß√£o**
   - Executar backend: `npm run dev`
   - Executar frontend: `npm run dev`
   - Testar autentica√ß√£o

2. **Configurar Dados de Produ√ß√£o**
   - Criar projeto separado para produ√ß√£o
   - Configurar dom√≠nio personalizado
   - Configurar backup autom√°tico

3. **Otimiza√ß√µes**
   - Configurar √≠ndices adicionais
   - Implementar cache
   - Configurar alertas

**üéâ Parab√©ns! Seu Supabase est√° configurado e pronto para uso!**